<section th:remove="tag" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <!-- Navigation Bar-->
    <header id="topnav" th:fragment="header">
        <!-- Top Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" th:href="@{${configuration.homeUrl}}">
                    <!-- Handle case where 'TRUST' is present -->
                    <span th:if="${appName.contains('Trust')}"
                          th:utext="${#strings.replace(appName, 'Trust', '<span class=&quot;text-warning&quot;>Trust</span>')}">
                </span>
                    <!-- Handle case where 'TRUST' is not present -->
                    <span th:unless="${appName.contains('Trust')}" th:text="${appName}">
                </span>
                </a>

                <!-- Search Form (visible on larger screens) -->
                <div class="d-none d-lg-block me-auto">
                    <form class="d-flex" role="search" onsubmit="return searchAuthorityName();">
                        <input class="form-control me-2" type="search" id="search-bar" th:placeholder="#{input.search} + '...'" aria-label="Search">
                        <button class="btn btn-outline-light" type="submit" onclick="searchAuthorityName()">
                            <i class="fa fa-search"></i>
                        </button>
                    </form>
                </div>

                <!-- Hamburger toggle button -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarToggler" aria-controls="navbarToggler"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- User menu -->
                <div class="collapse navbar-collapse" id="navbarToggler">
                    <!-- Search form (visible on mobile) -->
                    <form class="d-flex d-lg-none mt-3 mb-3" role="search" onsubmit="return searchAuthorityName();">
                        <input class="form-control me-2" type="search" id="search-bar-mobile" th:placeholder="#{input.search} + '...'" aria-label="Search">
                        <button class="btn btn-outline-light" type="submit" onclick="searchAuthorityName()">
                            <i class="fa fa-search"></i>
                        </button>
                    </form>

                    <!-- User dropdown on the right -->
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <img th:src="${@environment.getRequiredProperty('profile.url') + username}"
                                     alt="user-img" class="rounded-circle me-2" width="32" height="32">
                                <span th:text="${username}">Username</span>

                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <li class="dropdown-header">
                                    <h6 class="mb-0">Hi, <span>Bora</span></h6>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" th:href="@{#user/profile}" onclick="return loadPage(this);">
                                        <i class="fa fa-user-alt me-2"></i>
                                        <span th:text="#{label.profile}">Profile</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" th:href="@{/web/admin/authentication/logout}">
                                        <i class="fa fa-power-off me-2"></i>
                                        <span th:text="#{label.logout}">Logout</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Menu Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
            <div class="container">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#mainNavigation" aria-controls="mainNavigation"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="mainNavigation">
                    <ul class="navbar-nav">
                        <li th:each="menu, iter: ${session.authorityEntities}"
                            th:unless="${session.authorityEntities == null}"
                            th:if="${menu.parent == null}"
                            th:class="${menu.hasSub == true ? 'nav-item dropdown' : 'nav-item'}">

                            <!-- Top level menu items -->
                            <a th:if="${!menu.hasSub}" class="nav-link" th:href="${menu.endPointUrl}">
                                <i th:class="${menu.faIcon + ' me-1'}"></i>
                                <span th:text="${menu.authorityName}">Menu Item</span>
                            </a>

                            <!-- Dropdown menus -->
                            <a th:if="${menu.hasSub}" class="nav-link dropdown-toggle" href="#"
                               id="${'dropdown-' + menu.id}" role="button" data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <i th:class="${menu.faIcon + ' me-1'}"></i>
                                <span th:text="${menu.authorityName}">Dropdown</span>
                            </a>

                            <!-- Dropdown submenu items -->
                            <ul th:if="${menu.hasSub}" class="dropdown-menu shadow-sm"
                                aria-labelledby="${'dropdown-' + menu.id}">
                                <li th:each="subMenu,iterSubMenu : ${session.authorityEntities}"
                                    th:if="${subMenu.parent != null && subMenu.parent.id == menu.id}">
                                    <a class="dropdown-item" th:if="${subMenu.menu}"
                                       th:href="${'#' + #strings.replace(#strings.toLowerCase(subMenu.authorityName),' ','-')}"
                                       th:data-url="${subMenu.endPointUrl}"
                                       th:text="${subMenu.authorityName}"
                                       onclick="activeNavigation(this)">
                                        Submenu Item
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- ✅ Load jQuery FIRST -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- ✅ Then load jQuery UI if you use autocomplete -->
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>

        <script th:inline="javascript" th:if="${session.authorityEntities != null}">
            var menus = [[${session.authorityEntities}]];
            console.log('Menus:', menus);
            $(function () {
                var subMenus = [];
                var index = subMenus.length - 1;
                menus.forEach(menu => {
                    if (menu.parent !== null && menu.menu === true) {
                        subMenus[++index] = menu.authorityName;
                    }
                });
                $("#search-bar, #search-bar-mobile").autocomplete({
                    source: subMenus
                });
            });

            function searchAuthorityName() {
                var searchValue = $("#search-bar").val() || $("#search-bar-mobile").val();
                var menu = menus.filter(x => x.authorityName === searchValue)[0];
                if (menu !== undefined) {
                    window.location.href = menu.endPointUrl.replace('/admin/', "#");
                }
                return false;
            }
        </script>

        <script>
            function activeNavigation(e) {
                $('.active').removeClass('active');
                $(e).addClass('active').parents('.nav-item').addClass('active');
            }

            document.addEventListener('DOMContentLoaded', function() {
                const dropdownElementList = document.querySelectorAll('.dropdown')
                const dropdownList = [...dropdownElementList].map(dropdownEl => {
                    if (window.innerWidth >= 992) {
                        dropdownEl.addEventListener('mouseenter', function() {
                            this.querySelector('.dropdown-toggle').click();
                        });
                        dropdownEl.addEventListener('mouseleave', function() {
                            this.querySelector('.dropdown-toggle').click();
                        });
                    }
                });
            });
        </script>
    </header>
</section>