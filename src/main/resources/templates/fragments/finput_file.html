<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body th:fragment="finput_file">
<style>
    .pointer-cursor {
        cursor: pointer;
    }
    .documentTitle {
        background-color: transparent !important;
        border: 0 !important;
    }
</style>

<section th:remove="tag">
    <!-- Upload Input -->
    <div class="col-12" th:id="${ftableFile != null ? 'inputImgHeading_'+ ftableFile : 'inputImgHeading'}">
        <label th:for="${finputName}"
               th:utext="${finputText + (finputTitleRequired==true ? '<span class=text-danger>*</span>':'')}">
            Label Name<span class="text-danger" th:if="${finputTitleRequired==true}">*</span>
        </label>

        <!-- Hidden File Input -->
        <div class="d-none" id="fileInputPanel">
            <input type="file" onchange="viewFileNameAfterChoose()" id="fileInput" accept=".jpg,.jpeg,.png,.pdf" />
        </div>

        <!-- File Title and Selector -->
        <div class="row mb-3">
            <div class="col-md-6 mb-2">
                <input type="text"
                       th:required="${finputRequired==true}"
                       th:placeholder="'Enter ' + ${finputText}"
                       class="form-control"
                       id="documentTitle"/>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input class="form-control" readonly id="fileNameTemp"/>
                    <button class="btn btn-outline-secondary" type="button">
                        <label id="chooseFile" for="fileInput" class="m-0 pointer-cursor">
                            <span th:text="#{label.button.choose.file}">Choose file</span>
                        </label>
                    </button>
                    <button class="btn btn-primary" type="button" id="uploadIndex" onclick="addFileToTable()">
                        <span th:text="#{label.button.upload}">+ Upload</span>
                    </button>
                </div>
                <div><small class="text-muted" th:text="#{label.document.upload.detail}"></small></div>
            </div>
        </div>
    </div>

    <!-- Attachment Table -->
    <div class="col-12">
        <table class="table table-striped table-bordered table-hover add-edit-table table-column-dynamic"
               th:id="${ftableFile != null ? ftableFile : 'tableFile'}">
            <thead>
            <tr>
                <th th:text="#{label.no}">No</th>
                <th th:text="#{label.document.title}">Document Title</th>
                <th th:text="#{label.filename}">File Name</th>
                <th th:text="#{label.action}">Action</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Scripts -->
    <script th:inline="javascript">
        let indexInputFile = 0;


        let fisView =  /*[[${fisView}]]*/ true;
        let fisRemove =  /*[[${fisRemove}]]*/ true;
        let finputRequired =  /*[[${finputRequired}]]*/ true;
        let finputName =  /*[[${finputName}]]*/ 'file';
        let fattachList =  /*[[${fattachmentList}]]*/ null;
        let ftableFile =  /*[[${ftableFile}]]*/ 'tableFile';
        let labelRemoveFile = /*[[#{label.remove.file}]]*/ 'Remove';
        let labelViewFile = /*[[#{label.view.file}]]*/ 'View';

        $(document).ready(() => {
            if (fattachList && fattachList.length > 0) {
                for (let i = 0; i < fattachList.length; i++) {
                    indexInputFile++;
                    displayFile(i + 1, fattachList[i].remark, fattachList[i].originalFileName, null, fattachList[i].id, fattachList[i].fullUrl);
                }
            }
        });

        function addFileToTable() {
            const docTitle = $("#documentTitle").val();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!docTitle) {
                $('#documentTitle').addClass('is-invalid');
                return;
            } else {
                $('#documentTitle').removeClass('is-invalid');
            }

            if (!file) {
                return swal("File Required", "Please choose the file", "warning");
            }

            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                return swal("Incorrect file type.", "Only .jpg, .jpeg, .png, or .pdf allowed.", "warning");
            }

            indexInputFile++;
            const reader = new FileReader();
            reader.onload = function (e) {
                displayFile(indexInputFile, docTitle, file.name, reader.result, null, null);
                $("#documentTitle").val("");
                $("#fileNameTemp").val("");
            };
            reader.readAsDataURL(file);
        }

        function displayFile(no, title, fileName, base64, attachId, fileUrl) {
            const contentFile = base64 || fileUrl;
            const isPdf = fileName.endsWith(".pdf");
            const viewBtn = fisView
                ? `<a href="javascript:void(0);" onclick="openFile('${fileName}', '${contentFile}')">
                     <i class="fa fa-eye pointer-cursor me-1"></i>${labelViewFile}
                   </a>` : '';
            const removeBtn = fisRemove
                ? `<a href="javascript:void(0);" onclick="removeRow(this)">
                     <i class="fa fa-trash pointer-cursor me-1"></i>${labelRemoveFile}
                   </a>` : '';

            const actionDropdown = `
                <div class="dropdown">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>${viewBtn}</li>
                        <li>${removeBtn}</li>
                    </ul>
                </div>`;

            const row = `
                <tr>
                    <td>${no}</td>
                    <td><input class="form-control documentTitle" readonly value="${title}"/></td>
                    <td>${fileName}</td>
                    <td>${actionDropdown}</td>
                    <td class="d-none"><input type="file" name="${finputName}" id="backupFile_${no}"/></td>
                    <td class="d-none"><input type="text" name="attachmentId" value="${attachId}"/></td>
                </tr>`;

            $(`#${ftableFile}`).find('tbody').append(row);
        }

        function removeRow(row) {
            $(row).closest('tr').remove();
            indexInputFile--;
        }

        function viewFileNameAfterChoose() {
            const file = document.getElementById('fileInput').files[0];
            $("#fileNameTemp").val(file ? file.name : '');
        }

        function openFile(name, data) {
            const ext = name.split('.').pop();
            if (ext !== "pdf") {
                $('.zoom-gallery').magnificPopup({
                    delegate: 'a',
                    type: 'image',
                    closeOnContentClick: false,
                    closeBtnInside: false,
                    mainClass: 'mfp-with-zoom mfp-img-mobile',
                    image: { verticalFit: true },
                    gallery: { enabled: true },
                    zoom: {
                        enabled: true,
                        duration: 300,
                        opener: element => element.find('img')
                    }
                });
            } else {
                if (data.startsWith("data:")) {
                    const base64 = data.split(',')[1];
                    const blob = new Blob([base64ToArrayBuffer(base64)], { type: 'application/pdf' });
                    const blobURL = URL.createObjectURL(blob);
                    window.open(blobURL, '_blank');
                    URL.revokeObjectURL(blobURL);
                } else {
                    window.open(data, '_blank');
                }
            }
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }

    </script>
</section>
</body>
</html>
